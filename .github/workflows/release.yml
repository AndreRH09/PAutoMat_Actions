name: Release Build

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
        default: '1.0.0'

jobs:
  build:
    name: Build and Test Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: Download ChromeDriver
      run: |
        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d. -f1)
        CHROMEDRIVER_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/LATEST_RELEASE_${CHROME_VERSION}")
        if [ -z "$CHROMEDRIVER_VERSION" ]; then
          CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_VERSION}")
        fi
        if [ -n "$CHROMEDRIVER_VERSION" ]; then
          wget -O /tmp/chromedriver.zip "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip" || \
          wget -O /tmp/chromedriver.zip "https://edgedl.me.gvt1.com/edgedl/chrome/chrome-for-testing/${CHROMEDRIVER_VERSION}/linux64/chromedriver-linux64.zip"
          unzip -o /tmp/chromedriver.zip -d /tmp/
          sudo mv /tmp/chromedriver* /usr/local/bin/chromedriver 2>/dev/null || \
          sudo mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver
        fi
    
    - name: Setup resources
      run: |
        mkdir -p resources/Invoice_PDFs
        if [ ! -f "resources/test.properties" ]; then
          cat > resources/test.properties << EOF

sites:
  invoices:
    url: "https://www.invoicesimple.com/invoice-generator"
webdriver.chrome.driver=/usr/local/bin/chromedriver
applitools.api.key=\${APPLITOOLS_API_KEY}
EOF
        fi
    
    - name: Build project
      run: mvn clean package -DskipTests
    
    - name: Run tests
      env:
        APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
      run: |
        if [ -n "$APPLITOOLS_API_KEY" ]; then
          sed -i "s/applitools.api.key=.*/applitools.api.key=${APPLITOOLS_API_KEY}/" resources/test.properties
        fi
        mvn test
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-build
        path: |
          target/*.jar
          target/surefire-reports/
        retention-days: 30

